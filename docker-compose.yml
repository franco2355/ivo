services:
  # ==========================================
  # DATABASES
  # ==========================================

  mysql:
    image: mysql:9.3
    container_name: gym-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    ports:
      - "${MYSQL_EXTERNAL_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./BDD:/docker-entrypoint-initdb.d  # Scripts de inicializaci√≥n
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gym-network

  mongo:
    image: mongo:7.0
    container_name: gym-mongo
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    ports:
      - "${MONGO_EXTERNAL_PORT}:27017"
    volumes:
      - mongo_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gym-network

  # ==========================================
  # MESSAGE QUEUE
  # ==========================================

  rabbitmq:
    image: rabbitmq:3-management
    container_name: gym-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "${RABBITMQ_AMQP_PORT}:5672"    # AMQP port
      - "${RABBITMQ_MANAGEMENT_PORT}:15672"  # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gym-network

  # ==========================================
  # CACHE
  # ==========================================

  memcached:
    image: memcached:1.6-alpine
    container_name: gym-memcached
    command: ["-m", "64"]  # 64MB memory limit
    ports:
      - "${MEMCACHED_PORT}:11211"
    networks:
      - gym-network

  # ==========================================
  # SEARCH ENGINE
  # ==========================================

  solr:
    image: solr:9
    container_name: gym-solr
    ports:
      - "${SOLR_PORT}:8983"
    volumes:
      - solr_data:/var/solr
    command:
      - solr-precreate
      - ${SOLR_CORE}  # Core name
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8983/solr/${SOLR_CORE}/admin/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gym-network

  # ==========================================
  # MICROSERVICES
  # ==========================================

  users-api:
    build:
      context: ./backend/users-api
      dockerfile: Dockerfile
    container_name: gym-users-api
    environment:
      PORT: ${USERS_API_PORT}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_SCHEMA: ${DB_SCHEMA}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${USERS_API_PORT}:${USERS_API_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - gym-network
    restart: unless-stopped

  subscriptions-api:
    build:
      context: ./backend/subscriptions-api
      dockerfile: Dockerfile
    container_name: gym-subscriptions-api
    environment:
      PORT: ${SUBSCRIPTIONS_API_PORT}
      MONGO_URI: ${MONGO_URI}
      MONGO_DATABASE: ${MONGO_DATABASE_SUBSCRIPTIONS}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE}
      USERS_API_URL: ${USERS_API_URL}
      PAYMENTS_API_URL: ${PAYMENTS_API_URL}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${SUBSCRIPTIONS_API_PORT}:${SUBSCRIPTIONS_API_PORT}"
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - gym-network
    restart: unless-stopped

  activities-api:
    build:
      context: ./backend/activities-api
      dockerfile: Dockerfile
    container_name: gym-activities-api
    environment:
      PORT: ${ACTIVITIES_API_PORT}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_SCHEMA: ${DB_SCHEMA}
      JWT_SECRET: ${JWT_SECRET}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE}
      USERS_API_URL: ${USERS_API_URL}
      SUBSCRIPTIONS_API_URL: ${SUBSCRIPTIONS_API_URL}
    ports:
      - "${ACTIVITIES_API_PORT}:${ACTIVITIES_API_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - gym-network
    restart: unless-stopped

  payments-api:
    build:
      context: ./backend/payments-api
      dockerfile: Dockerfile
    container_name: gym-payments-api
    environment:
      PORT: ${PAYMENTS_API_PORT}
      MONGO_URI: ${MONGO_URI}
      MONGO_DATABASE: ${MONGO_DATABASE_PAYMENTS}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE}
      MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN}
      MERCADOPAGO_PUBLIC_KEY: ${MERCADOPAGO_PUBLIC_KEY}
      MERCADOPAGO_WEBHOOK_SECRET: ${MERCADOPAGO_WEBHOOK_SECRET}
      APP_URL: ${APP_URL}
      API_URL: ${API_URL}
    ports:
      - "${PAYMENTS_API_PORT}:${PAYMENTS_API_PORT}"
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - gym-network
    restart: unless-stopped

  search-api:
    build:
      context: ./backend/search-api
      dockerfile: Dockerfile
    container_name: gym-search-api
    environment:
      PORT: ${SEARCH_API_PORT}
      SOLR_URL: ${SOLR_URL}/${SOLR_CORE}
      SOLR_CORE: ${SOLR_CORE}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE}
      MEMCACHED_SERVERS: ${MEMCACHED_SERVERS}
      CACHE_TTL: ${CACHE_TTL}
      LOCAL_CACHE_TTL: ${LOCAL_CACHE_TTL}
      ACTIVITIES_API_URL: ${ACTIVITIES_API_URL}
      SUBSCRIPTIONS_API_URL: ${SUBSCRIPTIONS_API_URL}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_SCHEMA: ${DB_SCHEMA_ACTIVITIES}
    ports:
      - "${SEARCH_API_PORT}:${SEARCH_API_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      solr:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      memcached:
        condition: service_started
    networks:
      - gym-network
    restart: unless-stopped

  # ==========================================
  # FRONTEND (OPCIONAL)
  # ==========================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gym-frontend
    ports:
      - "5173:5173"
    depends_on:
      - users-api
      - subscriptions-api
      - activities-api
      - search-api
    networks:
      - gym-network

# ==========================================
# NETWORKS
# ==========================================

networks:
  gym-network:
    driver: bridge

# ==========================================
# VOLUMES
# ==========================================

volumes:
  mysql_data:
  mongo_data:
  rabbitmq_data:
  solr_data:
